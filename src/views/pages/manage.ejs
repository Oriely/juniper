<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %> 
</head>
<body>
    <%- include('../partials/navigation') %> 

    <div class="container center-h">
        <div class="wrapper">
            <div class="sites-list">
                <div class="site-list-row site-list-row-labels" >
                    <div class="site-name">Site Name</div>
                    <div class="site-description">Site subtitle</div>
                    <div class="site-url">Site URL</div>
                    <div></div>
                </div>
                <% sites.forEach(function (site) { %>
                    <div class="site-list-row" data-siteid="<%= site.id %>">
                        <div class="site-name"><%= site.name %></div>
                        <div class="site-description"><%= site.description %></div>
                        <div class="site-url"><%= site.url %></div>
                        <div class="site-list-controlls">
                            <button class="site-edit" data-siteid="<%= site.id %>"><i class="fa-solid fa-pencil"></i></button>
                            <button class="site-remove" data-siteid="<%= site.id %>"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
        <div class="wrapper">
            <form id="add-website-form" enctype="multipart/form-data">
                <div>
                    <label for="site-name">
                        Site name:<br>
                        <input name="site_name" id="site-name" type="text" placeholder="Sonarr">
                    </label>
                    
                    
                    <label for="site-description">
                        Site description:<br>
                        <input name="site_description" id="site-description" type="text" placeholder="TV Series">
                    </label>
                </div>
                <div>
                    <label for="site-url">
                        Site URL:<br>
                        <input name="site_url" id="site-url" type="text" placeholder="/sonarr">
                    </label>
                    <label class="upload-logo">
                        <div>
                            Site logo:<br>
                            <label for="upload_logo" class="file-upload">
                                <i class="fa fa-cloud-upload"></i> Upload image
                            </label>
                            <input accept="image/*" id="upload_logo" type="file" name="">
                        </div>
                        <div class="">
                            <img class="site-logo-preview" src="images/logo.png" alt="">
                        </div>
                    </label>
                </div>
                <div>
                    <button id="add-website-button" type="submit">Add site</button>
                    <button id="edit-website-button" type="submit">Edit Site</button>
                </div>
            </form>
        </div>

    </div>
    <%- include('../partials/scripts') %> 
    <script>

        const uploadLogo = document.getElementById('upload_logo');
        const logoPreview = document.querySelector('.site-logo-preview')

        let isEditing = false;
        let siteEditing = null;


        function updateList() {
            
        }
        async function getSite(id) {
            const response = await fetch('/api/sites/' + id);
            return response.json();
        }

        function updateRow(id) {
            const site_rows = Array.from(document.querySelectorAll('.site-list-row'));
            const row = site_rows.filter(site_row => site_row.dataset.siteid == id)

            console.log(row[0])
        }

        function updateForm(site, form) {
            addSiteForm['site_name'].value = site.name;
            addSiteForm['site_description'].value = site.description;
            addSiteForm['site_url'].value = site.url;
        }

        async function editSite(event, form) {
            const siteId = event.currentTarget.dataset.siteid;
            const site = await getSite(siteId);
            const addSiteForm = form;
            siteEditing = siteId;

            updateForm(site, form);
        }

        function saveEdit(event) {
            const siteId = event.currentTarget.dataset.siteid;
            updateRow(siteId);
        }

        function removeSite(event) {
            const siteId = event.currentTarget.dataset.siteid;
            console.log(event.currentTarget)
            // console.log('/manage/remove/' + siteId)
            // fetch('/manage/remove/' + siteId, {
            //     method: 'POST',
            // });
            
        }

        function addSite(event) {

            if(isEditing) return;
            event.preventDefault();
            const addSiteForm = document.getElementById('add-website-form');

            const formData = new FormData(addSiteForm);


            fetch('/manage/add', {
                method: 'POST',
                body: formData,
            })
            .then((res) => res.json())
            .then((data) => {
                if(data.success) {

                } else {
                    console.log('Something went wrong..')
                }
            });
        }




        uploadLogo.onchange = e => {
            console.log('test')
            const [file] = uploadLogo.files
            console.log(file)
            if(file) {
                logoPreview.src = URL.createObjectURL(file)
            }
        }

        const removeSiteBtns = document.querySelectorAll('.site-remove');
        const editSiteBtns = document.querySelectorAll('.site-edit');
        const addSiteForm = document.getElementById('add-website-form');

        addSiteForm.addEventListener('submit', (event) => {
            event.preventDefault();

            if(event.submitter.id === 'edit-website-button') {
                saveEdit(event)
            } else {
                addSite(event, form)
            }
        })

        removeSiteBtns.forEach((btn) => {
            btn.addEventListener('click', removeSite)
        })
        editSiteBtns.forEach((btn) => {
            btn.addEventListener('click', (event) => editSite(event, addSiteForm))
        })

    </script>

</body>
</html>